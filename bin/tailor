#!/usr/bin/env ruby

require 'trollop'
require_relative '../lib/tailor'
require_relative '../lib/tailor/cli_helpers'
require_relative '../lib/tailor/runtime_error'

Tailor.log = false

opts = Trollop.options do
  banner Tailor::CLIHelpers.banner
  version Tailor::CLIHelpers.version
  opt :config, "Pass a config file; if no arg, show config.",
    short: "-c"
  opt :debug, "Turn on debug logging.", short: "-d"
end

if opts[:config]
  if ARGV.size.zero?
    puts Tailor::CLIHelpers.version
    puts Tailor::CLIHelpers.config
    exit
  elsif ARGV.size == 1
    Tailor.config = ARGV.shift
    puts Tailor::CLIHelpers.version
    puts Tailor::CLIHelpers.config
    exit
  elsif ARGV.size == 2
    new_config_file = ARGV.shift
    Tailor.config = new_config_file
    Tailor.log "Using config file: #{File.expand_path(new_config_file)}"
  end
end

if opts[:debug]
  Tailor.log = true
end

stuff_to_check = ARGV[0]

if stuff_to_check.nil?
  puts Tailor::CLIHelpers.banner
  exit
end

begin
  unless Tailor.checkable? stuff_to_check
    raise Tailor::RuntimeError, "Invalid file or directory: #{stuff_to_check}"
  end

  Tailor.check_style(stuff_to_check)
  Tailor.print_report
rescue Tailor::RuntimeError => ex
  puts ex.message
  puts ex.backtrace.join("\n")
  puts
ensure
  exit(1) if Tailor.problem_count > 0
end
